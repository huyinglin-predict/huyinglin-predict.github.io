<!--index.html-->
<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebView Message Port Demo</title>
</head>
<body>
    <script id="user-data" type="application/json">
{"requestId": "cloudx41156124564","eventName": "SendQuery","eventParams": {"text": "关闭所有闹钟","textHidden": true,"cardInfo": {"triggerInfo": {"座位": "3排6座","场次": "2026-03-19 19:00","片名": "小黄人"}}}}
    </script>
    <h1>WebView Message Port Demo</h1>
    <div>
        <input type="button" value="SendToEts" onclick="PostMsgToEts(jsonString);"/><br/>
    </div>
    <p class="output">display received message send from ets</p>
</body>

<script>
const jsonElement = document.getElementById('user-data');
const jsonString = jsonElement.innerText
var h5Port;
var output = document.querySelector('.output');

window.addEventListener('message', function (event) {
    if (event.data === '__Celia_AgentGUI_Port__') { // 初始化名称是__Celia_AgentGUI_Port__
        if (event.ports[0] !== null) {
            h5Port = event.ports[0]; // 1. 保存从应用侧发送过来的端口。
            h5Port.onmessage = function (event) {
              // 2. 接收ets侧发送过来的消息。
              var msg = 'Got message from ets:';
              var result = event.data;
              if (typeof(result) === 'string') {
                console.info(`received string message from ets, string is: ${result}`);
                msg = msg + result;
              } else if (typeof(result) === 'object') {
                if (result instanceof ArrayBuffer) {
                  console.info(`received arraybuffer from ets, length is: ${result.byteLength}`);
                  msg = msg + 'length is ' + result.byteLength;
                } else {
                  console.info('not support');
                }
              } else {
                console.info('not support');
              }
              output.innerHTML = msg;
            }
        }
    }
})

// 3. 使用h5Port向应用侧发送消息。
function PostMsgToEts(data) {
    console.log(jsonString)
    if (h5Port) {
      h5Port.postMessage(data);
    } else {
      console.error('h5Port is null, Please initialize first');
    }
}

</script>
</html>
